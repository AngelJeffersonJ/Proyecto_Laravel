name: Azure Web App Deploy - Laravel

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout del repositorio
    - name: Checkout repo
      uses: actions/checkout@v4

    # Configuración de PHP para Laravel
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, intl, pdo_mysql, bcmath, openssl
        tools: composer

    # Instalar dependencias Composer (solo producción, más ligero)
    - name: Install dependencies
      run: composer install --no-dev --optimize-autoloader

    # Configurar Laravel APP_KEY
    - name: Generate APP_KEY
      run: |
        cp .env.example .env
        php artisan key:generate

    # ---------- Azure Deployment Block (el que dio tu profe) ----------
    - name: Laravel optimizations
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      env:
        APP_ENV: production
        APP_DEBUG: false
        APP_KEY: ${{ secrets.APP_KEY }}

    # Empaquetar para despliegue
    - name: Create deployment package
      run: zip -r release.zip . -x '*.git*'

    # Subir artifact al job de deployment
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: laravel-app
        path: release.zip

  deploy:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: laravel-app

    # Desplegar a Azure Web App
    - name: Deploy to Azure WebApp
      uses: azure/webapps-deploy@v2
      with:
        app-name: YOUR_APP_NAME_HERE
        slot-name: production
        publish-profile: ${{ secrets.AzureAppService_PublishProfile }}
        package: release.zip
