name: Deploy Laravel to Azure

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifact from Build workflow
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: AngelJeffersonJ/Proyecto_Laravel
        workflow: build.yml            # ğŸ‘ˆ workflow que genera el ZIP
        name: php-app                  # ğŸ‘ˆ nombre del artifact
        path: ./artifact
        check_artifacts: true

    - name: Show downloaded files
      run: ls -R ./artifact

    # ğŸ” Login to Azure using Managed Identity
    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        auth-type: IDENTITY
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }} # ğŸ‘ˆ NECESARIO

    # ğŸš€ Deploy to Azure WebApp
    - name: Deploy ZIP to App Service
      uses: azure/webapps-deploy@v3
      with:
        app-name: "rg-laravel-c7h0h3fcbaacata0" # ğŸ‘ˆ Nombre EXACTO del App Service
        package: "./artifact/php-app.zip"        # ğŸ‘ˆ ZIP a desplegar
